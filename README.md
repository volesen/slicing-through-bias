# slicing-through-bias

Repository for the [MICCAI 2024 FAIMI workshop](https://faimi-workshop.github.io/2024-miccai/) paper *[Slicing Through Bias: Explaining Performance Gaps in Medical Image Analysis using Slice Discovery Methods](https://arxiv.org/abs/2406.12142)*

A [fork](https://github.com/volesen/detecting_causes_of_gender_bias_chest_xrays) of the code for the 2023 FAIMI paper [Are Sex-based Physiological Differences the Cause of Gender Bias for Chest X-ray Diagnosis?](https://arxiv.org/abs/2308.05129) is used to export the embeddings used in the paper.

This repository contains the code for
1. Dimensionality reductions of the exported embeddings
2. Generating figures for the paper

We reuse the environment from the forked repository.

## Generating embeddings

Follow the instructions given in the [forked repository](https://github.com/volesen/detecting_causes_of_gender_bias_chest_xrays) to download the data and generate the embeddings.

The labels for the datasets, see `datafiles/`, have been augmented by adding a `Drain` column, kindly provided by the authors of [Augmenting Chest X-ray Datasets with Non-Expert Annotations](https://arxiv.org/pdf/2309.02244) and [Detecting Shortcuts in Medical Images -- A Case Study in Chest X-rays](https://arxiv.org/abs/2211.04279).

With the forked repository as the current working directory, the embeddings can be generated by running the following commands:

```bash
python prediction/disease_prediction.py -s <dataset> -d <disease> -f 0 50 100 -n 1 -r 0-10 -p <img-dir> --run_dir <run-directory>
```

For the paper, embeddings where generated for the following diseases: `Atelectasis` and `Pneumothorax` on `NIH` and `chexpert`.
The artifacts generated by the command will be saved in the `<run-directory>` and is used in the following steps.

## Dimensionality reduction

To apply dimensionality reduction to the embeddings, run the following command:

```bash
python embeddings.py --path <run-directory> --dataset=<dataset> --dimension <embedding-dimension>
```

This will save the embeddings with the specified dimension in the `<run-directory>`.
In the final paper, we used the embeddings with 128 dimensions.

## Generating figures

The figures in the paper can be generated by running the following commands:

```bash
python comorbidity_plot.py --path <run-directory> --dataset=<dataset> --disease=<disease> --case=<case> --output=<output-directory>
```

The plots were generated with case set to `positive` and `negative`.
